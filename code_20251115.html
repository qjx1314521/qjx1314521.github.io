<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接码发卡系统 - 自动接码平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 1.2rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .btn-group {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        button {
            flex: 1;
            padding: 0.9rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        #generateBtn {
            background: #4299e1;
            color: #fff;
        }
        #generateBtn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        #startBtn {
            background: #48bb78;
            color: #fff;
        }
        #startBtn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        #startBtn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }
        .link-box {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #e8f4f8;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .link-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        .link-desc {
            color: #4a5568;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .result {
            padding: 1.2rem;
            background: #f0f8fb;
            border-radius: 6px;
            display: none;
            border: 1px solid #e8f4f8;
        }
        .result-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .code-item {
            margin: 0.6rem 0;
            color: #4a5568;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }
        .code-label {
            font-weight: 500;
        }
        .code-value {
            color: #2d3748;
            font-family: "Consolas", monospace;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .footer {
            text-align: center;
            margin-top: 2rem;
            color: #718096;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>接码发卡系统</h1>
        
        <div class="form-group">
            <label for="link">随机接码链接（单次有效）</label>
            <input type="text" id="link" readonly placeholder="点击生成按钮获取专属接码链接">
        </div>
        
        <div class="btn-group">
            <button id="generateBtn">生成接码链接</button>
            <button id="startBtn" disabled>开始自动接码</button>
        </div>
        
        <div class="link-box">
            <div class="link-title">使用说明</div>
            <div class="link-desc">
                1. 点击「生成接码链接」获取唯一专属链接（仅一次有效）<br>
                2. 复制链接打开后，系统自动获取手机号并显示<br>
                3. 待目标平台发送验证码后，系统自动提取并展示<br>
                4. 链接使用后立即失效，需重新生成新链接
            </div>
        </div>
        
        <div class="result" id="result">
            <div class="result-title">接码结果</div>
            <div class="code-item">
                <span class="code-label">手机号：</span>
                <span class="code-value" id="phone">-</span>
            </div>
            <div class="code-item">
                <span class="code-label">验证码：</span>
                <span class="code-value" id="code"><span class="loading" style="display: none;"></span>获取中...</span>
            </div>
            <div class="code-item">
                <span class="code-label">状态：</span>
                <span class="code-value" id="status">等待接码</span>
            </div>
        </div>
    </div>

    <div class="footer">
        系统提示：仅用于合法合规场景，请勿用于违规操作
    </div>

    <script>
        // API配置
        const API_CONFIG = {
            getPhone: "https://api.haozhuma.com/sms/?api=getPhone&token=12979f4ebab7cfff6034169e78dbad19435a93f14b9837ecbe86b7f57bb4f1031dc391ddf3237ee23dd322f1d42670b8e5c6769c53ff33125808850d8b430ce7d466da5bfe5610fb0b7fc0218bf57da9&sid=76980",
            getMessage: "https://api.haozhuma.com/sms/?api=getMessage&token=12979f4ebab7cfff6034169e78dbad19435a93f14b9837ecbe86b7f57bb4f1031dc391ddf3237ee23dd322f1d42670b8e5c6769c53ff33125808850d8b430ce7d466da5bfe5610fb0b7fc0218bf57da9&sid=76980&phone="
        };

        // 全局变量
        let currentLink = "";
        let currentPhone = "";
        let codeTimer = null;
        let isFetching = false;

        // DOM元素
        const $link = document.getElementById("link");
        const $generateBtn = document.getElementById("generateBtn");
        const $startBtn = document.getElementById("startBtn");
        const $result = document.getElementById("result");
        const $phone = document.getElementById("phone");
        const $code = document.getElementById("code");
        const $status = document.getElementById("status");
        const $loading = document.querySelector(".loading");

        // 生成随机接码链接（基于UUID思想，确保唯一性）
        function generateUniqueLink() {
            const uuid = crypto.randomUUID(); // 现代浏览器支持，生成标准UUID
            return `${window.location.origin}/?sid=${uuid}`;
        }

        // 生成链接按钮事件
        $generateBtn.addEventListener("click", () => {
            // 停止之前的接码流程
            if (codeTimer) {
                clearInterval(codeTimer);
                resetResult();
            }
            
            // 生成新链接
            currentLink = generateUniqueLink();
            $link.value = currentLink;
            
            // 启用接码按钮
            $startBtn.disabled = false;
            
            // 隐藏结果区域
            $result.style.display = "none";
        });

        // 开始接码按钮事件
        $startBtn.addEventListener("click", async () => {
            if (isFetching) return;
            isFetching = true;
            
            // 更新按钮状态
            $startBtn.disabled = true;
            $generateBtn.disabled = true;
            $startBtn.innerHTML = "<span class='loading'></span>处理中";
            
            try {
                // 1. 获取手机号
                $result.style.display = "block";
                $status.textContent = "正在获取手机号...";
                
                const phoneRes = await fetch(API_CONFIG.getPhone, {
                    method: "GET",
                    timeout: 10000 // 10秒超时
                });
                
                if (!phoneRes.ok) throw new Error(`网络错误：${phoneRes.status}`);
                
                const phoneData = await phoneRes.json();
                console.log("手机号接口返回：", phoneData);
                
                if (phoneData.code === 0 && phoneData.data?.phone) {
                    currentPhone = phoneData.data.phone;
                    $phone.textContent = currentPhone;
                    $status.textContent = "手机号已获取，等待验证码...";
                    
                    // 2. 轮询获取验证码（优化：初始延迟2秒，每2秒查询一次，持续60秒）
                    let queryCount = 0;
                    const maxQueryCount = 30; // 60秒
                    
                    codeTimer = setInterval(async () => {
                        if (queryCount >= maxQueryCount) {
                            clearInterval(codeTimer);
                            $code.innerHTML = "获取超时";
                            $status.textContent = "验证码获取超时";
                            isFetching = false;
                            $generateBtn.disabled = false;
                            $startBtn.innerHTML = "开始自动接码";
                            return;
                        }

                        try {
                            const codeRes = await fetch(`${API_CONFIG.getMessage}${currentPhone}`, {
                                method: "GET",
                                timeout: 8000
                            });
                            
                            if (!codeRes.ok) throw new Error(`验证码接口错误：${codeRes.status}`);
                            
                            const codeData = await codeRes.json();
                            console.log("验证码接口返回：", codeData);
                            
                            if (codeData.code === 0 && codeData.data?.msg) {
                                // 优化验证码提取：支持4-6位数字，适配不同平台
                                const codeMatch = codeData.data.msg.match(/\d{4,6}/);
                                if (codeMatch) {
                                    const verifyCode = codeMatch[0];
                                    $code.textContent = verifyCode;
                                    $status.textContent = "验证码获取成功";
                                    clearInterval(codeTimer);
                                    
                                    // 标记链接失效
                                    currentLink = "";
                                    $link.value = "链接已失效";
                                    
                                    // 恢复按钮状态
                                    isFetching = false;
                                    $generateBtn.disabled = false;
                                    $startBtn.innerHTML = "开始自动接码";
                                } else {
                                    $status.textContent = `等待验证码（${queryCount * 2}秒）`;
                                }
                            } else {
                                $status.textContent = `等待验证码（${queryCount * 2}秒）`;
                            }
                        } catch (codeErr) {
                            console.error("验证码查询失败：", codeErr);
                            $status.textContent = "查询异常，重试中...";
                        }
                        
                        queryCount++;
                    }, 2000);
                } else {
                    throw new Error(phoneData.msg || "手机号获取失败，未知错误");
                }
            } catch (err) {
                console.error("接码流程失败：", err);
                $result.style.display = "block";
                $status.textContent = `错误：${err.message}`;
                $phone.textContent = "获取失败";
                $code.textContent = "获取失败";
                
                // 恢复按钮状态
                isFetching = false;
                $generateBtn.disabled = false;
                $startBtn.innerHTML = "开始自动接码";
            }
        });

        // 重置结果区域
        function resetResult() {
            $phone.textContent = "-";
            $code.innerHTML = "<span class='loading' style='display: none;'></span>获取中...";
            $status.textContent = "等待接码";
            $result.style.display = "none";
        }

        // 页面加载时检查是否为接码链接，自动触发接码（需配合后端验证链接有效性）
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const linkSid = urlParams.get("sid");
            if (linkSid) {
                // 模拟链接验证（实际需后端接口验证）
                setTimeout(() => {
                    $generateBtn.click(); // 生成链接
                    setTimeout(() => $startBtn.click(), 500); // 自动开始接码
                }, 1000);
            }
        };

        // 监听页面关闭，清理定时器
        window.addEventListener("beforeunload", () => {
            if (codeTimer) clearInterval(codeTimer);
        });
    </script>
</body>
</html>
